<div class="wallet-backdrop" (click)="close()">
  <div class="wallet-modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">

    <header class="modal-header">
      <h1>Podsumowanie portfela</h1>
      <button class="close-btn" (click)="close()">×</button>
    </header>

    <div class="managed-control">
      <label for="risk-select">Automatyczny handel (profil ryzyka)</label>
      <div class="managed-actions">
        <select id="risk-select" [(ngModel)]="selectedRisk" aria-label="Wybierz profil ryzyka">
          <option *ngFor="let r of riskOptions" [ngValue]="r.value">{{ r.label }}</option>
        </select>

        <button class="btn-manage" (click)="enableManaged()" [disabled]="loadingManaged">
          {{ loadingManaged
              ? 'Zastosowywanie...'
              : (selectedRisk === 0 ? 'Wyłącz automatyczny handel' : 'Zastosuj profil ryzyka') }}
        </button>
      </div>
    </div>


    <section class="summary">
      <div class="row">
        <div class="label">Łączna wartość (USDC)</div>
        <div class="value">
          {{ (walletService.totalUsd$ | async) | number:'1.2-2' }}
        </div>
      </div>

      <ng-container *ngIf="walletService.percentChange$ | async as pct">
      <div class="row">
        <div class="label">Zmiana względem początkowej wartości</div>
        <div class="value" [class.positive]="pct >= 0" [class.negative]="pct < 0">
        {{ pct | number:'1.2-2' }}%
        </div>
      </div>
      </ng-container>

      <div class="row">
        <div class="label">Udział gotówki</div>
        <div class="value">{{ (walletService.cashShare$ | async) | percent:'1.2-2' }}</div>
      </div>

      <div class="wallet-worth-chart">
        <wallet-worth-chart></wallet-worth-chart>
      </div>
    </section>
    <section class="assets-section">
      <main class="asset-list">
        <h2>Assets</h2>

        <div *ngIf="(walletService.loading$ | async)" class="loading">Loading...</div>

        <ng-container *ngIf="!(walletService.loading$ | async)">
          <ul *ngIf="(walletService.assets$ | async) as assets">
            <li>
              <div class="label"><strong>Nazwa</strong></div>
              <div class="label"><strong>Ilość</strong></div>
              <div class="label"><strong>Wartość w USD</strong></div>
              <div class="label"><strong>Zysk/Strata</strong></div>
              <div class="label"><strong>Akcje</strong></div>
            </li>
            <li *ngFor="let a of assets">
              <div class="asset-name">{{ a.name }}</div>
              <div class="asset-amount">{{ a.amount }}</div>
              <div class="asset-usd">$ {{ a.usdValue | number:'1.2-2' }} </div>
              <div
                class="asset-pnl"
                [class.positive]="a.name !== 'USDC' && a.pnl >= 0"
                [class.negative]="a.name !== 'USDC' && a.pnl < 0"
                [class.neutral]="a.name === 'USDC'"
              >
                <ng-container *ngIf="a.name !== 'USDC'; else noPnl">
                  $ {{ a.pnl | number:'1.2-2' }}
                </ng-container>
                <ng-template #noPnl></ng-template>
              </div>
              <button class="close-position-btn" (click)="closePosition(a.name, a.amount)">Zamknij pozycję</button>
            </li>
          </ul>
          <div *ngIf="walletService.assets$ | async as assets; else noAssets" class="empty"></div>
          <ng-template #noAssets>
            <div class="empty">Brak aktywów w portfelu</div>
          </ng-template>
        </ng-container>
      </main>
      <aside class="asset-chart">
        <pie-chart></pie-chart>
      </aside>

    </section>

  </div>
</div>